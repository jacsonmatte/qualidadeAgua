<!DOCTYPE html>
<html lang="pt-BR" class=""> <!-- A classe 'dark' será adicionada aqui via JS -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multilab: Monitoramento da Água</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js (Mapas) CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Chart.js (Gráficos) CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Define a fonte padrão */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Ajustes para o popup do Leaflet */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background-color: #fff; /* Fundo claro padrão */
            color: #1a202c; /* Texto escuro padrão */
        }
        .leaflet-popup-content {
            margin: 15px;
            font-size: 14px;
            line-height: 1.6;
        }
        .leaflet-popup-content h4 {
            font-weight: 700;
            color: #1f2937; /* Cor do título no popup */
            margin-bottom: 8px;
        }
        
        /* Estilos do popup no modo escuro */
        .dark .leaflet-popup-content-wrapper {
            background-color: #1f2937; /* bg-gray-800 */
            color: #f3f4f6; /* text-gray-100 */
            border: 1px solid #374151; /* border-gray-700 */
        }
        .dark .leaflet-popup-content h4 {
            color: #fff; /* text-white */
        }
        .dark .leaflet-popup-close-button {
            color: #9ca3af; /* text-gray-400 */
        }
        .dark .leaflet-popup-close-button:hover {
            color: #fff;
        }

        .popup-button {
            display: block;
            width: 100%;
            padding: 8px 12px;
            margin-top: 10px;
            background-color: #2563eb; /* bg-blue-600 */
            color: white;
            text-align: center;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .popup-button:hover {
            background-color: #1d4ed8; /* bg-blue-700 */
            text-decoration: none;
            color: white;
        }
        #map {
            z-index: 10;
        }

        /* Esconde o ícone que não está ativo no botão do tema */
        .dark #theme-toggle-sun-icon {
            display: block;
        }
        .dark #theme-toggle-moon-icon {
            display: none;
        }
        #theme-toggle-sun-icon {
            display: none;
        }
        #theme-toggle-moon-icon {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen transition-colors duration-300">

    <!-- Cabeçalho Fixo -->
    <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-50 border-b border-gray-200 dark:border-gray-700">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <!-- Logo e Título -->
            <div class="flex items-center gap-3">
                <div class="text-3xl font-bold text-blue-600 dark:text-blue-500">
                    Multilab
                </div>
            </div>
            
            <!-- Título central (visível em telas maiores) e Botão de Tema -->
            <div class="flex items-center gap-4">
                <div class="hidden md:block text-lg font-semibold text-gray-700 dark:text-gray-300">
                    Monitoramento e controle da qualidade de água
                </div>
                
                <!-- Botão de Tema -->
                <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5">
                    <!-- Ícone de Lua -->
                    <svg id="theme-toggle-moon-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                    <!-- Ícone de Sol -->
                    <svg id="theme-toggle-sun-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm0 13a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm8-5a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM3 10a1 1 0 01-1 1H1a1 1 0 110-2h1a1 1 0 011 1zM16 14.59A1 1 0 0114.59 16l-.707-.707a1 1 0 011.414-1.414l.707.707zM5.41 4l-.707-.707a1 1 0 011.414-1.414l.707.707A1 1 0 015.41 4zM14.59 4A1 1 0 0116 5.41l-.707.707a1 1 0 01-1.414-1.414l.707-.707zM4 14.59A1 1 0 015.41 16l-.707.707a1 1 0 01-1.414-1.414l.707-.707zM10 7a3 3 0 100 6 3 3 0 000-6z"></path>
                    </svg>
                </button>
            </div>
        </nav>
    </header>

    <!-- Conteúdo Principal -->
    <main class="container mx-auto p-4 md:p-8">

        <!-- Visualização do Mapa (Padrão) -->
        <div id="mapView">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100 mb-4">Pontos de Coleta - Oeste de Santa Catarina</h1>
            <p class="text-lg text-gray-600 dark:text-gray-300 mb-6">Clique em um ponto no mapa para ver o relatório detalhado e o histórico de análises.</p>
            <div id="map" class="h-[400px] md:h-[600px] w-full rounded-lg shadow-xl border border-gray-200 dark:border-gray-700"></div>
        </div>

        <!-- Visualização de Detalhes (Oculta por padrão) -->
        <div id="detailsView" class="hidden">
            <!-- Botão de Voltar -->
            <button id="backButton" class="mb-6 flex items-center gap-2 bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
                Voltar ao Mapa
            </button>

            <!-- Cabeçalho do Ponto de Coleta -->
            <div class="mb-8">
                <h2 id="pointTitle" class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-gray-100"></h2>
                <p id="pointLocation" class="text-xl text-gray-600 dark:text-gray-300 mt-1"></p>
            </div>

            <!-- Dashboard de Análise (BI) -->
            <div class="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700">
                <h3 class="text-2xl font-semibold mb-6 text-gray-800 dark:text-gray-100">Painel de Análise Dinâmica</h3>
                
                <!-- (NOVO) Filtros de Categoria -->
                <div id="filterButtons" class="flex flex-wrap gap-2 mb-8">
                    <!-- Botões de filtro serão injetados aqui pelo JavaScript -->
                </div>

                <!-- Contêiner dos Gráficos Individuais -->
                <div id="chartsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Gráficos individuais serão injetados aqui pelo JavaScript -->
                </div>

                <!-- Tabela de Histórico de Amostras -->
                <h4 class="text-2xl font-semibold mt-12 mb-6 text-gray-800 dark:text-gray-100">Histórico Completo das Amostras</h4>
                <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                    <table id="historyTable" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <!-- Cabeçalho da tabela será inserido dinamicamente -->
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Linhas da tabela serão inseridas dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 mt-12">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 text-center text-gray-500 dark:text-gray-400 text-sm">
            &copy; 2025 Multilab. Todos os direitos reservados.
        </div>
    </footer>


    <!-- Lógica JavaScript da Aplicação -->
    <script>
        // --- DADOS FICTÍCIOS ---
        const samplePoints = [
            {
                id: 1,
                name: "Poço Artesiano - Bairro Efapi",
                location: "Chapecó, SC",
                coords: [-27.1146, -52.6189],
                // PARÂMETROS ATUALIZADOS (com mais dados para filtros)
                parameters: [
                    'pH', 'Turbidez (NTU)', 'Coliformes Totais (NMP/100mL)', // Principais
                    'Nitrato (mg/L)', // Nutrientes
                    'Cloro_Livre (mg/L)', 'Dureza_Total (mg/L de Ca)', // Físico-Químicos
                    'Al (mg/L)', 'Fe (mg/L)', 'Mn (mg/L)', 'Cu (mg/L)', // Metais (mg/L)
                    'Pb (ug/L)', 'Cd (ug/L)' // (NOVO) Metais (ug/L)
                ],
                history: [
                    // HISTÓRICO ATUALIZADO (com novos dados)
                    { date: '2025-01-15', 'pH': 7.2, 'Turbidez (NTU)': 0.8, 'Coliformes Totais (NMP/100mL)': 10, 'Nitrato (mg/L)': 5.5, 'Cloro_Livre (mg/L)': 0.5, 'Dureza_Total (mg/L de Ca)': 60, 'Al (mg/L)': 0.1, 'Fe (mg/L)': 0.1, 'Mn (mg/L)': 0.05, 'Cu (mg/L)': 0.1, 'Pb (ug/L)': 5, 'Cd (ug/L)': 2 },
                    { date: '2025-04-20', 'pH': 7.0, 'Turbidez (NTU)': 1.1, 'Coliformes Totais (NMP/100mL)': 25, 'Nitrato (mg/L)': 6.1, 'Cloro_Livre (mg/L)': 0.3, 'Dureza_Total (mg/L de Ca)': 65, 'Al (mg/L)': 0.25, 'Fe (mg/L)': 0.4, 'Mn (mg/L)': 0.08, 'Cu (mg/L)': 0.05, 'Pb (ug/L)': 12, 'Cd (ug/L)': 6 },
                    { date: '2025-07-10', 'pH': 7.1, 'Turbidez (NTU)': 0.9, 'Coliformes Totais (NMP/100mL)': 5,  'Nitrato (mg/L)': 5.8, 'Cloro_Livre (mg/L)': 0.6, 'Dureza_Total (mg/L de Ca)': 62, 'Al (mg/L)': 0.15, 'Fe (mg/L)': 0.2, 'Mn (mg/L)': 0.12, 'Cu (mg/L)': 0.2, 'Pb (ug/L)': 8, 'Cd (ug/L)': 4 },
                    { date: '2025-10-05', 'pH': 7.3, 'Turbidez (NTU)': 1.3, 'Coliformes Totais (NMP/100mL)': 40, 'Nitrato (mg/L)': 6.5, 'Cloro_Livre (mg/L)': 0.4, 'Dureza_Total (mg/L de Ca)': 70, 'Al (mg/L)': 0.3, 'Fe (mg/L)': 0.35, 'Mn (mg/L)': 0.15, 'Cu (mg/L)': 0.1, 'Pb (ug/L)': 15, 'Cd (ug/L)': 7 }
                ]
            },
            {
                id: 2,
                name: "Rio Guatambú - Ponto de Coleta",
                location: "Guatambú, SC",
                coords: [-27.1380, -52.7845],
                parameters: ['pH', 'Oxigênio Dissolvido (mg/L)', 'DBO (mg/L)', 'Fósforo Total (mg/L)'],
                history: [
                    { date: '2025-02-01', 'pH': 6.8, 'Oxigênio Dissolvido (mg/L)': 6.5, 'DBO (mg/L)': 3.0, 'Fósforo Total (mg/L)': 0.1 },
                    { date: '2025-05-15', 'pH': 6.9, 'Oxigênio Dissolvido (mg/L)': 6.2, 'DBO (mg/L)': 3.5, 'Fósforo Total (mg/L)': 0.15 },
                    { date: '2025-08-12', 'pH': 6.7, 'Oxigênio Dissolvido (mg/L)': 5.9, 'DBO (mg/L)': 4.1, 'Fósforo Total (mg/L)': 0.2 },
                    { date: '2025-11-02', 'pH': 7.0, 'Oxigênio Dissolvido (mg/L)': 6.8, 'DBO (mg/L)': 2.8, 'Fósforo Total (mg/L)': 0.08 }
                ]
            },
            {
                id: 3,
                name: "Nascente - Linha São Roque",
                location: "Chapecó (Interior), SC",
                coords: [-27.0850, -52.6500],
                parameters: ['pH', 'Turbidez (NTU)', 'Nitrato (mg/L)', 'Dureza (mg/L)'],
                history: [
                    { date: '2025-03-10', 'pH': 6.5, 'Turbidez (NTU)': 0.4, 'Nitrato (mg/L)': 2.1, 'Dureza (mg/L)': 50 },
                    { date: '2025-06-15', 'pH': 6.6, 'Turbidez (NTU)': 0.5, 'Nitrato (mg/L)': 2.3, 'Dureza (mg/L)': 52 },
                    { date: '2025-09-20', 'pH': 6.4, 'Turbidez (NTU)': 0.6, 'Nitrato (mg/L)': 2.5, 'Dureza (mg/L)': 55 },
                    { date: '2025-12-01', 'pH': 6.5, 'Turbidez (NTU)': 0.4, 'Nitrato (mg/L)': 2.2, 'Dureza (mg/L)': 51 }
                ]
            }
        ];

        // --- VARIÁVEIS GLOBAIS ---
        let map;
        let currentPointData = null;
        let activeCharts = [];
        let currentFilterCategory = 'principais'; // NOVO: Guarda o estado do filtro

        // (NOVO) Objeto de categorização de parâmetros
        const PARAMETER_CATEGORIES = {
            // Categoria: 'principais'
            'pH': 'principais',
            'Turbidez (NTU)': 'principais',
            'Coliformes Totais (NMP/100mL)': 'principais',
            'E_coli': 'principais',

            // Categoria: 'metais' (baseado no CSV e Portaria 888)
            'Al (mg/L)': 'metais',
            'As (mg/L)': 'metais',
            'Ba (mg/L)': 'metais',
            'Cd (mg/L)': 'metais',
            'Cr (mg/L)': 'metais',
            'Cu (mg/L)': 'metais',
            'Fe (mg/L)': 'metais',
            'Mn (mg/L)': 'metais',
            'Ni (mg/L)': 'metais',
            'Pb (mg/L)': 'metais',
            'Sb (mg/L)': 'metais',
            'Se (mg/L)': 'metais',
            'Zn (mg/L)': 'metais',
            'Na (mg/L)': 'metais',
            // (NOVO) Metais em ug/L
            'Pb (ug/L)': 'metais',
            'Cd (ug/L)': 'metais',

            // Categoria: 'nutrientes'
            'Nitrato (mg/L)': 'nutrientes',
            'Fósforo Total (mg/L)': 'nutrientes',
            'Amonio (mg/L)': 'nutrientes',

            // Categoria: 'fisico-quimicos'
            'Dureza_Total (mg/L de Ca)': 'fisico-quimicos',
            'Dureza (mg/L)': 'fisico-quimicos',
            'DBO (mg/L)': 'fisico-quimicos',
            'Oxigênio Dissolvido (mg/L)': 'fisico-quimicos',
            'Cloro_Livre (mg/L)': 'fisico-quimicos',
            
            // Categoria: 'outros'
            // ... (outros parâmetros podem ser adicionados aqui)
        };
        
        // VMP (Valores Máximos Permitidos) - Portaria 888
        // LIMITES ATUALIZADOS (com mais metais)
        const VMP_LIMITS = {
            'pH': { min: 6.0, max: 9.5 },
            'Turbidez (NTU)': { max: 5.0 },
            'Coliformes Totais (NMP/100mL)': { max: 0 },
            'Nitrato (mg/L)': { max: 10.0 },
            'Dureza_Total (mg/L de Ca)': { max: 300 },
            'Dureza (mg/L)': { max: 300 },
            'Cloro_Livre (mg/L)': { min: 0.2, max: 5.0 },
            
            // Metais (Portaria 888, Anexo X)
            'Al (mg/L)': { max: 0.2 },
            'Fe (mg/L)': { max: 0.3 },
            'Mn (mg/L)': { max: 0.1 },
            'Cu (mg/L)': { max: 2.0 },
            'As (mg/L)': { max: 0.01 },
            'Ba (mg/L)': { max: 0.7 },
            'Cd (mg/L)': { max: 0.005 },
            'Cr (mg/L)': { max: 0.05 },
            'Ni (mg/L)': { max: 0.07 },
            'Pb (mg/L)': { max: 0.01 },
            'Sb (mg/L)': { max: 0.02 },
            'Se (mg/L)': { max: 0.01 },
            'Zn (mg/L)': { max: 5.0 },
            'Na (mg/L)': { max: 200 },
            
            // (NOVO) VMP para ug/L (convertido da Portaria)
            'Pb (ug/L)': { max: 10 }, // VMP é 0.01 mg/L
            'Cd (ug/L)': { max: 5 },  // VMP é 0.005 mg/L
            
            // Limites CONAMA (Rio)
            'Oxigênio Dissolvido (mg/L)': { min: 5.0 },
            'DBO (mg/L)': { max: 5.0 },
            'Fósforo Total (mg/L)': { max: 0.1 }
        };
        
        // Cores para os gráficos
        const CHART_COLORS = [
            '#3b82f6', // blue-500
            '#ec4899', // pink-500
            '#10b981', // emerald-500
            '#f59e0b', // amber-500
            '#8b5cf6', // violet-500
            '#ef4444', // red-500
        ];

        // --- REFERÊNCIAS DE ELEMENTOS DOM ---
        const themeToggleButton = document.getElementById('theme-toggle');
        const mapView = document.getElementById('mapView');
        const detailsView = document.getElementById('detailsView');
        const backButton = document.getElementById('backButton');
        const pointTitle = document.getElementById('pointTitle');
        const pointLocation = document.getElementById('pointLocation');
        const historyTable = document.getElementById('historyTable');

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            initMap();
            addMarkers();
            
            // Event Listeners
            backButton.addEventListener('click', showMapView);
            themeToggleButton.addEventListener('click', toggleTheme);
        });

        // --- LÓGICA DO TEMA (CLARO/ESCURO) ---

        function initializeTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.theme = isDark ? 'dark' : 'light';
            
            // ATUALIZADO:
            // Recria os gráficos com o filtro ATUAL
            if (currentPointData) {
                createIndividualCharts(currentPointData, currentFilterCategory);
            }
        }
        
        function isDarkMode() {
            return document.documentElement.classList.contains('dark');
        }

        // --- FUNÇÕES DO MAPA ---

        function initMap() {
            const mapCenter = [-27.10, -52.68];
            map = L.map('map', {
                scrollWheelZoom: false
            }).setView(mapCenter, 10);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            map.on('click', () => map.scrollWheelZoom.enable());
            map.on('mouseout', () => map.scrollWheelZoom.disable());
        }

        function addMarkers() {
            samplePoints.forEach(point => {
                const marker = L.marker(point.coords).addTo(map);
                
                const popupContent = `
                    <h4>${point.name}</h4>
                    <p>${point.location}</p>
                    <a href="#" class="popup-button" onclick="event.preventDefault(); showDetailsView(${point.id})">
                        Ver Detalhes
                    </a>
                `;
                
                marker.bindPopup(popupContent);
            });
        }

        // --- FUNÇÕES DE CONTROLE DE VISUALIZAÇÃO ---

        /**
         * Exibe a tela de detalhes para um ponto de coleta específico.
         */
        window.showDetailsView = (pointId) => {
            currentPointData = samplePoints.find(p => p.id === pointId);
            if (!currentPointData) return;

            pointTitle.textContent = currentPointData.name;
            pointLocation.textContent = currentPointData.location;
            
            populateHistoryTable(currentPointData);

            // NOVO: Cria os botões de filtro e os gráficos (com filtro padrão 'principais')
            populateFilterButtons(currentPointData.parameters);
            createIndividualCharts(currentPointData, 'principais');

            mapView.classList.add('hidden');
            detailsView.classList.remove('hidden');
            
            window.scrollTo(0, 0);
        }

        /**
         * Retorna para a visualização do mapa.
         */
        function showMapView() {
            detailsView.classList.add('hidden');
            mapView.classList.remove('hidden');
            
            destroyActiveCharts();
            
            currentPointData = null;
            currentFilterCategory = 'principais'; // Reseta o filtro
            
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        }
        
        // --- FUNÇÕES DO PAINEL DE DETALHES (BI) ---

        /**
         * Limpa os gráficos ativos e o contêiner.
         */
        function destroyActiveCharts() {
            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];
            const chartsContainer = document.getElementById('chartsContainer');
            if (chartsContainer) {
                chartsContainer.innerHTML = '';
            }
        }

        /**
         * (NOVA FUNÇÃO) Cria os botões de filtro dinamicamente.
         */
        function populateFilterButtons(pointParameters) {
            const container = document.getElementById('filterButtons');
            container.innerHTML = ''; // Limpa botões antigos

            // 1. Encontra as categorias únicas para este ponto
            const categoriesInPoint = new Set(
                pointParameters.map(p => PARAMETER_CATEGORIES[p] || 'outros')
            );

            // 2. Define a ordem e os nomes dos botões
            const buttonMap = {
                'principais': 'Principais',
                'metais': 'Metais',
                'nutrientes': 'Nutrientes',
                'fisico-quimicos': 'Físico-Químicos',
                'outros': 'Outros'
            };

            const allCategories = ['principais', 'metais', 'nutrientes', 'fisico-quimicos', 'outros'];

            // 3. Cria os botões (incluindo "Todos")
            // Filtra para mostrar apenas categorias que existem no ponto
            const categoriesToShow = allCategories.filter(c => categoriesInPoint.has(c));
            
            // Adiciona "Ver Todos" se houver mais de uma categoria
            if (categoriesToShow.length > 1) {
                categoriesToShow.unshift('todos');
                buttonMap['todos'] = 'Ver Todos';
            }

            // Se não houver categorias (poucos dados), não mostra botões
            if (categoriesToShow.length <= 1) {
                container.innerHTML = '';
                return;
            }

            categoriesToShow.forEach(category => {
                const button = document.createElement('button');
                button.dataset.filter = category;
                button.textContent = buttonMap[category];
                button.className = 'filter-button px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200';
                
                // Define o estilo do botão (ativo vs. inativo)
                updateButtonStyles(button, category === currentFilterCategory);

                button.addEventListener('click', () => {
                    currentFilterCategory = category; // Atualiza o estado
                    
                    // Atualiza o estilo de todos os botões
                    container.querySelectorAll('.filter-button').forEach(btn => {
                        updateButtonStyles(btn, btn.dataset.filter === currentFilterCategory);
                    });
                    
                    // Recria os gráficos com o novo filtro
                    createIndividualCharts(currentPointData, currentFilterCategory);
                });
                container.appendChild(button);
            });

            // Seta o estilo do botão "Principais" como ativo na primeira carga
            updateButtonStyles(container.querySelector('[data-filter="principais"]'), true);
            currentFilterCategory = 'principais'; // Garante que o estado inicial é 'principais'
        }

        /**
         * (NOVA FUNÇÃO AUXILIAR) Atualiza o estilo dos botões de filtro.
         */
        function updateButtonStyles(button, isActive) {
            if (!button) return;
            if (isActive) {
                button.classList.add('bg-blue-600', 'text-white', 'shadow-md');
                button.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-300', 'dark:hover:bg-gray-600');
            } else {
                button.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
                button.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-300', 'dark:hover:bg-gray-600');
            }
        }

        /**
         * Preenche a tabela com o histórico de dados do ponto.
         */
        function populateHistoryTable(point) {
            const thead = historyTable.querySelector('thead');
            const tbody = historyTable.querySelector('tbody');
            
            thead.innerHTML = '';
            tbody.innerHTML = '';

            const headerRow = document.createElement('tr');
            
            const thDate = document.createElement('th');
            thDate.textContent = 'Data da Coleta';
            thDate.classList.add('px-6', 'py-3', 'text-left', 'text-xs', 'font-bold', 'text-gray-600', 'dark:text-gray-300', 'uppercase', 'tracking-wider');
            headerRow.appendChild(thDate);
            
            point.parameters.forEach(param => {
                const th = document.createElement('th');
                th.textContent = param;
                th.classList.add('px-6', 'py-3', 'text-left', 'text-xs', 'font-bold', 'text-gray-600', 'dark:text-gray-300', 'uppercase', 'tracking-wider');
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            point.history.forEach(sample => {
                const dataRow = document.createElement('tr');
                dataRow.classList.add('hover:bg-gray-50', 'dark:hover:bg-gray-700');
                
                const tdDate = document.createElement('td');
                tdDate.textContent = new Date(sample.date).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                tdDate.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-medium', 'text-gray-900', 'dark:text-white');
                dataRow.appendChild(tdDate);
                
                point.parameters.forEach(param => {
                    const td = document.createElement('td');
                    td.textContent = sample[param] !== undefined ? sample[param] : 'N/A';
                    td.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-600', 'dark:text-gray-300');
                    dataRow.appendChild(td);
                });
                tbody.appendChild(dataRow);
            });
        }

        /**
         * (MODIFICADA) Cria os gráficos para uma categoria específica.
         * @param {object} point - O objeto do ponto de coleta.
         * @param {string} filterCategory - A categoria para filtrar (ex: 'principais', 'metais', 'todos')
         */
        function createIndividualCharts(point, filterCategory) {
            // 1. Limpa gráficos anteriores
            destroyActiveCharts();
            
            const chartsContainer = document.getElementById('chartsContainer');
            const labels = point.history.map(sample => 
                new Date(sample.date).toLocaleDateString('pt-BR', { year: '2-digit', month: '2-digit', day: '2-digit', timeZone: 'UTC' })
            );
            
            // Cores base para os gráficos
            const fontColor = isDarkMode() ? '#f3f4f6' : '#374151';
            const gridColor = isDarkMode() ? '#374151' : '#e5e7eb';

            // 2. (NOVO) Filtra os parâmetros com base na categoria
            const filteredParameters = point.parameters.filter(param => {
                if (filterCategory === 'todos') {
                    return true; // Mostra todos
                }
                const category = PARAMETER_CATEGORIES[param] || 'outros';
                return category === filterCategory;
            });

            // 3. Verifica se há parâmetros para mostrar
            if (filteredParameters.length === 0) {
                 chartsContainer.innerHTML = `<p class="text-gray-600 dark:text-gray-400 col-span-1 md:col-span-2 text-center">Nenhum parâmetro encontrado para a categoria "${filterCategory}".</p>`;
                 return;
            }

            // 4. Itera e cria os gráficos APENAS para os parâmetros filtrados
            filteredParameters.forEach((param, index) => {
                // 1. Criar a estrutura HTML do card do gráfico
                const chartId = `chart-${param.replace(/[^a-zA-Z0-9]/g, '')}`; // Cria um ID seguro
                const card = document.createElement('div');
                card.className = "bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 shadow-md";
                card.innerHTML = `
                    <h5 class="text-lg font-semibold text-center mb-4 text-gray-800 dark:text-gray-100">${param}</h5>
                    <div class="relative h-[250px] w-full">
                        <canvas id="${chartId}"></canvas>
                    </div>
                `;
                chartsContainer.appendChild(card);

                // 2. Preparar dados para este gráfico
                const data = point.history.map(sample => sample[param]);
                const color = CHART_COLORS[index % CHART_COLORS.length];
                
                const datasets = [{
                    label: param,
                    data: data,
                    borderColor: color,
                    borderWidth: 3,
                    tension: 0.1,
                    fill: false,
                    pointBackgroundColor: color,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }];

                // 3. Adicionar linhas de limite (VMP)
                const limit = VMP_LIMITS[param];
                if (limit) {
                    if (limit.max !== undefined) {
                        datasets.push({
                            label: `VMP (Max: ${limit.max})`,
                            data: new Array(labels.length).fill(limit.max),
                            borderColor: '#ef4444', // red-500
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                            tension: 0
                        });
                    }
                    if (limit.min !== undefined) {
                        datasets.push({
                            label: `Limite Mín. (${limit.min})`,
                            data: new Array(labels.length).fill(limit.min),
                            borderColor: '#f97316', // orange-500
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                            tension: 0
                        });
                    }
                }

                // 4. Criar o Chart.js
                const ctx = document.getElementById(chartId).getContext('2d');
                const newChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: fontColor,
                                    font: { size: 12 },
                                    boxWidth: 20
                                }
                            },
                            tooltip: {
                                backgroundColor: isDarkMode() ? '#1f2937' : '#fff',
                                titleColor: isDarkMode() ? '#fff' : '#333',
                                bodyColor: isDarkMode() ? '#ddd' : '#555',
                                borderColor: gridColor,
                                borderWidth: 1,
                                padding: 10,
                                displayColors: true
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: fontColor, font: { size: 10 } },
                                grid: { color: gridColor, drawOnChartArea: false }
                            },
                            y: {
                                title: {
                                    display: false,
                                },
                                ticks: { color: fontColor, font: { size: 12 } },
                                grid: { color: gridColor },
                                min: (limit && limit.max === 0) ? 0 : undefined
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index',
                        }
                    }
                });
                
                // 5. Armazenar a instância para destruição posterior
                activeCharts.push(newChart);
            });
        }

    </script>
</body>
</html>